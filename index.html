<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>本日の設定 - オーダーシステム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f8;
      margin: 0;
      padding: 16px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 18px;
      margin: 0 0 8px;
    }
    section {
      background: #ffffff;
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th,
    td {
      border-bottom: 1px solid #ddd;
      padding: 4px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f0f0f5;
    }
    .room-name-cell {
      min-width: 5em;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
    }
    .btn-primary {
      background: #2c7be5;
      border: none;
      color: #ffffff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 16px;
      cursor: pointer;
    }
    .btn-primary:hover {
      background: #1b64c7;
    }
    .btn-ghost {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f8f8f8;
      cursor: pointer;
      font-size: 12px;
    }
    .flex {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .small-note {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5f0ff;
      font-size: 11px;
      margin-right: 4px;
      color: #295a9f;
    }
    .room-tags {
      margin-top: 4px;
      font-size: 11px;
    }
    .room-tags label {
      margin-right: 6px;
      white-space: nowrap;
    }
    .extra-room-select {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 8px;
      max-height: 80px;
      overflow-y: auto;
      padding: 2px 0;
    }
    .extra-room-select label {
      font-size: 11px;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <h1>本日の設定</h1>
  <p class="small-note">
    固定部屋は初期チェックON / 本日の設定はブラウザ内に保存され、翌日にはリセットされます（仕様）。
  </p>

  <!-- 部屋設定 -->
  <section>
    <h2>部屋設定</h2>
    <table id="roomTable">
      <thead>
        <tr>
          <th>使用</th>
          <th>部屋</th>
          <th>人数</th>
          <th>時間</th>
          <th>プラン<br/><span style="font-weight:normal;">＋ ケーキ / プレート</span></th>
          <th>メモ（10文字まで）</th>
        </tr>
      </thead>
      <tbody>
        <!-- JSで自動生成 -->
      </tbody>
    </table>

    <div class="flex" style="margin-top: 8px;">
      <span>カスタム部屋名：</span>
      <input
        type="text"
        id="customRoomName"
        placeholder="例：団体席A"
        style="max-width: 180px;"
      />
      <button type="button" id="addRoomBtn" class="btn-ghost">追加</button>
    </div>
    <p class="small-note">
      固定部屋：やまぶき／なでしこ／つばき／やしお／さくら／ふじ／さつき／きすげ／ゆり／はぎ
    </p>
  </section>

  <!-- 追加料理設定 -->
  <section>
    <h2>追加料理設定</h2>
    <div class="small-note">
      <span class="pill">品名：自由記入</span>
      <span class="pill">数量：1〜3 ／ カスタマイズ</span>
      <span class="pill">挿入位置：果菜盛の前 など</span>
      <span class="pill">部屋指定：複数選択可</span>
    </div>
    <table id="extraTable" style="margin-top: 8px;">
      <thead>
        <tr>
          <th>品名</th>
          <th>数量</th>
          <th>挿入位置</th>
          <th>部屋指定</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <!-- JSで行を生成 -->
      </tbody>
    </table>
    <button type="button" id="addExtraBtn" class="btn-ghost" style="margin-top: 8px;">
      行を追加
    </button>
    <p class="small-note">
      部屋を指定しない場合は、全室のコースに反映されます。
    </p>
  </section>

  <!-- スタッフ設定 -->
  <section>
    <h2>スタッフ（出勤者）</h2>
    <div id="staffList" class="flex"></div>
    <div class="flex" style="margin-top: 8px;">
      <span>カスタムスタッフ：</span>
      <input
        type="text"
        id="customStaffName"
        placeholder="例：ヘルプさん"
        style="max-width: 180px;"
      />
      <span class="small-note">※複数いる場合は「Aさん／Bさん」などでまとめてもOK</span>
    </div>
  </section>

  <!-- 保存ボタン -->
  <section style="text-align: center;">
    <button class="btn-primary" id="saveBtn">保存して Order 画面へ</button>
    <p class="small-note">
      保存後、ブラウザのローカルに当日分のデータを保持し、Order 画面に自動で移動します。
    </p>
  </section>

  <script>
    // ===== 定数・共通処理 =====
    const DEFAULT_ROOMS = [
      "やまぶき",
      "なでしこ",
      "つばき",
      "やしお",
      "さくら",
      "ふじ",
      "さつき",
      "きすげ",
      "ゆり",
      "はぎ"
    ];
    const DEFAULT_STAFFS = ["真弓", "ミングマ", "ボビー", "サラミ", "パビ", "翔平"];
    const STORAGE_KEY = "orderSystemIndexV1";

    function getTodayKey() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function getCurrentRoomNames() {
      const names = [];
      document.querySelectorAll("#roomTable tbody tr").forEach((tr) => {
        const name =
          tr.dataset.roomName ||
          tr.querySelector(".room-name-cell").textContent.trim();
        if (name) names.push(name);
      });
      return names;
    }

    // ===== 部屋行生成 =====
    function createRoomRow(name, options = {}) {
      const tbody = document.querySelector("#roomTable tbody");
      const tr = document.createElement("tr");

      const enabled = options.enabled !== undefined ? options.enabled : true;
      const peopleDisplay = options.peopleDisplay || "2名"; // 表示用の文字列
      const time = options.time || "18:00";
      const plan = options.plan || "standard";
      const memo = options.memo || "";
      const isCustom = options.isCustom || false;
      const cake = !!options.cake;
      const plate = !!options.plate;

      const candidatePeople = ["2名", "3名", "4名", "5名", "6名"];
      let selectValue;
      let customValue = "";
      if (candidatePeople.includes(peopleDisplay)) {
        selectValue = peopleDisplay;
      } else {
        selectValue = "custom";
        customValue = peopleDisplay;
      }

      tr.dataset.roomName = name;
      tr.dataset.isCustom = isCustom ? "1" : "0";

      tr.innerHTML = `
        <td>
          <input type="checkbox" class="room-enabled" ${enabled ? "checked" : ""} />
        </td>
        <td class="room-name-cell">${name}</td>
        <td>
          <select class="room-people">
            <option value="2名" ${selectValue === "2名" ? "selected" : ""}>2名</option>
            <option value="3名" ${selectValue === "3名" ? "selected" : ""}>3名</option>
            <option value="4名" ${selectValue === "4名" ? "selected" : ""}>4名</option>
            <option value="5名" ${selectValue === "5名" ? "selected" : ""}>5名</option>
            <option value="6名" ${selectValue === "6名" ? "selected" : ""}>6名</option>
            <option value="custom" ${selectValue === "custom" ? "selected" : ""}>カスタム</option>
          </select>
          <input
            type="text"
            class="room-people-custom"
            style="margin-top: 4px; display: ${selectValue === "custom" ? "block" : "none"};"
            placeholder="例：3〜4名"
            value="${customValue}"
          />
        </td>
        <td>
          <select class="room-time">
            <option value="18:00" ${time === "18:00" ? "selected" : ""}>18:00</option>
            <option value="18:30" ${time === "18:30" ? "selected" : ""}>18:30</option>
            <option value="19:00" ${time === "19:00" ? "selected" : ""}>19:00</option>
          </select>
        </td>
        <td>
          <select class="room-plan">
            <option value="standard" ${plan === "standard" ? "selected" : ""}>スタンダード</option>
            <option value="wagyu" ${plan === "wagyu" ? "selected" : ""}>和牛懐石</option>
            <option value="steak" ${plan === "steak" ? "selected" : ""}>ステーキ</option>
            <option value="shabu" ${plan === "shabu" ? "selected" : ""}>しゃぶしゃぶ</option>
            <option value="renpaku" ${plan === "renpaku" ? "selected" : ""}>連泊</option>
          </select>
          <div class="room-tags">
            <label>
              <input type="checkbox" class="room-cake" ${cake ? "checked" : ""} />
              ケーキ
            </label>
            <label>
              <input type="checkbox" class="room-plate" ${plate ? "checked" : ""} />
              プレート
            </label>
          </div>
        </td>
        <td>
          <input type="text" maxlength="10" class="room-memo" value="${memo}" />
        </td>
      `;

      tbody.appendChild(tr);

      const select = tr.querySelector(".room-people");
      const customInput = tr.querySelector(".room-people-custom");
      select.addEventListener("change", () => {
        if (select.value === "custom") {
          customInput.style.display = "block";
        } else {
          customInput.style.display = "none";
        }
      });

      // 部屋が増えたら、追加料理の部屋指定も更新
      refreshAllExtraRoomSelectors();
    }

    // ===== 追加料理行生成 =====
    function addExtraRow(options = {}) {
      const tbody = document.querySelector("#extraTable tbody");
      const tr = document.createElement("tr");

      const name = options.name || "";
      const qty = options.qty || "1";
      const qtyCustom = options.qtyCustom || "";
      const pos = options.position || "before-kasai";
      const targetRooms = options.targetRooms || [];

      tr.innerHTML = `
        <td>
          <input
            type="text"
            class="extra-name"
            placeholder="品名"
            value="${name}"
          />
        </td>
        <td>
          <select class="extra-qty">
            <option value="1" ${qty === "1" ? "selected" : ""}>1</option>
            <option value="2" ${qty === "2" ? "selected" : ""}>2</option>
            <option value="3" ${qty === "3" ? "selected" : ""}>3</option>
            <option value="custom" ${qty === "custom" ? "selected" : ""}>カスタム</option>
          </select>
          <input
            type="text"
            class="extra-qty-custom"
            style="margin-top: 4px; display: ${qty === "custom" ? "block" : "none"};"
            placeholder="例：大人4名分"
            value="${qty === "custom" ? qtyCustom : ""}"
          />
        </td>
        <td>
          <select class="extra-position">
            <option value="before-kasai" ${pos === "before-kasai" ? "selected" : ""}>果菜盛の前</option>
            <option value="before-mushi" ${pos === "before-mushi" ? "selected" : ""}>蒸物の前</option>
            <option value="before-age" ${pos === "before-age" ? "selected" : ""}>揚物の前</option>
            <option value="before-ni" ${pos === "before-ni" ? "selected" : ""}>煮物の前</option>
            <option value="before-gohan" ${pos === "before-gohan" ? "selected" : ""}>ご飯の前</option>
            <option value="before-amami" ${pos === "before-amami" ? "selected" : ""}>甘味の前</option>
          </select>
        </td>
        <td>
          <div class="extra-room-select"></div>
          <div class="small-note">※未選択の場合は全室に適用</div>
        </td>
        <td>
          <button type="button" class="extra-remove btn-ghost">削除</button>
        </td>
      `;

      tbody.appendChild(tr);

      const qtySel = tr.querySelector(".extra-qty");
      const qtyCustomInput = tr.querySelector(".extra-qty-custom");
      qtySel.addEventListener("change", () => {
        qtyCustomInput.style.display =
          qtySel.value === "custom" ? "block" : "none";
      });

      tr.querySelector(".extra-remove").addEventListener("click", () => {
        tr.remove();
      });

      // 部屋指定チェックボックスを反映
      refreshExtraRowRoomSelector(tr, targetRooms);
    }

    function refreshExtraRowRoomSelector(tr, targetRoomsOverride) {
      const container = tr.querySelector(".extra-room-select");
      if (!container) return;

      let selected = new Set();
      if (Array.isArray(targetRoomsOverride)) {
        selected = new Set(targetRoomsOverride);
      } else {
        container
          .querySelectorAll("input[type=checkbox]:checked")
          .forEach((chk) => selected.add(chk.value));
      }

      container.innerHTML = "";
      const rooms = getCurrentRoomNames();
      rooms.forEach((name) => {
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" value="${name}" ${
          selected.has(name) ? "checked" : ""
        } />
          ${name}
        `;
        container.appendChild(label);
      });
    }

    function refreshAllExtraRoomSelectors() {
      document
        .querySelectorAll("#extraTable tbody tr")
        .forEach((tr) => refreshExtraRowRoomSelector(tr));
    }

    // ===== スタッフ描画 =====
    function renderStaffs(selectedList) {
      const container = document.getElementById("staffList");
      container.innerHTML = "";

      const current =
        selectedList && selectedList.length
          ? new Set(selectedList)
          : new Set(DEFAULT_STAFFS);

      DEFAULT_STAFFS.forEach((name) => {
        const label = document.createElement("label");
        label.style.marginRight = "8px";
        label.innerHTML = `
          <input type="checkbox" value="${name}" ${
          current.has(name) ? "checked" : ""
        } />
          ${name}
        `;
        container.appendChild(label);
      });
    }

    // ===== 保存データ読み込み（当日限定） =====
    function loadIndexData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      try {
        const data = JSON.parse(raw);
        if (!data.date || data.date !== getTodayKey()) {
          // 日付が違う場合は当日データとして扱わずに無視
          return null;
        }
        return data;
      } catch (e) {
        console.error("loadIndexData error", e);
        return null;
      }
    }

    // ===== フォーム収集 =====
    function collectFormData() {
      const rooms = [];
      document.querySelectorAll("#roomTable tbody tr").forEach((tr) => {
        const enabled = tr.querySelector(".room-enabled").checked;
        const name =
          tr.dataset.roomName ||
          tr.querySelector(".room-name-cell").textContent.trim();

        const peopleSel = tr.querySelector(".room-people");
        const peopleCustom = tr
          .querySelector(".room-people-custom")
          .value.trim();
        let peopleDisplay;
        if (peopleSel.value === "custom") {
          peopleDisplay = peopleCustom || "カスタム";
        } else {
          peopleDisplay = peopleSel.value; // "2名" など
        }

        const time = tr.querySelector(".room-time").value;
        const plan = tr.querySelector(".room-plan").value;
        const memo = tr.querySelector(".room-memo").value.trim();
        const cake = tr.querySelector(".room-cake").checked;
        const plate = tr.querySelector(".room-plate").checked;

        rooms.push({
          name,
          enabled,
          peopleDisplay,
          time,
          plan,
          memo,
          cake,
          plate,
          isCustom: tr.dataset.isCustom === "1"
        });
      });

      const extras = [];
      document.querySelectorAll("#extraTable tbody tr").forEach((tr) => {
        const name = tr.querySelector(".extra-name").value.trim();
        if (!name) return;

        const qtySel = tr.querySelector(".extra-qty");
        const qtyCustomInput = tr.querySelector(".extra-qty-custom");
        let qty = qtySel.value;
        let qtyCustom = "";
        if (qty === "custom") {
          qtyCustom = qtyCustomInput.value.trim();
        }

        const position = tr.querySelector(".extra-position").value;
        const targetRooms = [];
        tr
          .querySelectorAll(".extra-room-select input[type=checkbox]:checked")
          .forEach((chk) => targetRooms.push(chk.value));

        extras.push({
          name,
          qty,
          qtyCustom,
          position,
          targetRooms
        });
      });

      const staffs = [];
      document
        .querySelectorAll("#staffList input[type=checkbox]")
        .forEach((chk) => {
          if (chk.checked) staffs.push(chk.value);
        });

      const customStaff = document
        .getElementById("customStaffName")
        .value.trim();
      if (customStaff) {
        staffs.push(customStaff);
      }

      return {
        date: getTodayKey(),
        rooms,
        extras,
        staffs
      };
    }

    // ===== 初期化 =====
    function init() {
      const data = loadIndexData();

      // 部屋
      if (data && Array.isArray(data.rooms) && data.rooms.length) {
        data.rooms.forEach((r) => {
          createRoomRow(r.name, {
            enabled: r.enabled,
            peopleDisplay: r.peopleDisplay,
            time: r.time,
            plan: r.plan,
            memo: r.memo,
            isCustom: r.isCustom,
            cake: r.cake,
            plate: r.plate
          });
        });
      } else {
        DEFAULT_ROOMS.forEach((name) => createRoomRow(name));
      }

      // スタッフ
      renderStaffs(data?.staffs || DEFAULT_STAFFS);

      // 追加料理
      if (data && Array.isArray(data.extras)) {
        data.extras.forEach((ex) => addExtraRow(ex));
      }

      // イベント設定
      document
        .getElementById("addRoomBtn")
        .addEventListener("click", () => {
          const input = document.getElementById("customRoomName");
          const name = input.value.trim();
          if (!name) {
            alert("部屋名を入力してください。");
            return;
          }
          createRoomRow(name, { isCustom: true });
          input.value = "";
        });

      document
        .getElementById("addExtraBtn")
        .addEventListener("click", () => {
          addExtraRow();
        });

      document.getElementById("saveBtn").addEventListener("click", () => {
        const payload = collectFormData();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        // ここで Order 画面へ遷移（まだ中身はこれから作る）
        window.location.href = "order.html";
      });

      // 念のため初期表示時にも部屋指定セレクタを整える
      refreshAllExtraRoomSelectors();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
